var __webpack_modules__={683:(e,t,n)=>{function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}n.r(t),function(e){var t=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||e.msRequestAnimationFrame||function(e){return setTimeout(e,16)};function n(){var n=this;n.reads=[],n.writes=[],n.raf=t.bind(e)}function s(e){e.scheduled||(e.scheduled=!0,e.raf(r.bind(null,e)))}function r(e){var t,n=e.writes,o=e.reads;try{o.length,e.runTasks(o),n.length,e.runTasks(n)}catch(e){t=e}if(e.scheduled=!1,(o.length||n.length)&&s(e),t){if(t.message,!e.catch)throw t;e.catch(t)}}function i(e,t){var n=e.indexOf(t);return!!~n&&!!e.splice(n,1)}n.prototype={constructor:n,runTasks:function(e){for(var t;t=e.shift();)t()},measure:function(e,t){var n=t?e.bind(t):e;return this.reads.push(n),s(this),n},mutate:function(e,t){var n=t?e.bind(t):e;return this.writes.push(n),s(this),n},clear:function(e){return i(this.reads,e)||i(this.writes,e)},extend:function(e){if("object"!=o(e))throw new Error("expected object");var t=Object.create(this);return function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}(t,e),t.fastdom=this,t.initialize&&t.initialize(),t},catch:null};var a=e.fastdom=e.fastdom||new n;"function"==typeof define?define((function(){return a})):"object"==("undefined"==typeof module?"undefined":o(module))&&(module.exports=a)}("undefined"!=typeof window?window:void 0)}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](n,n.exports,__webpack_require__),n.exports}__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};(()=>{var exports=__webpack_exports__,__webpack_unused_export__;__webpack_unused_export__={value:!0},__webpack_unused_export__=void 0;const fastdom=__webpack_require__(683),ELEMENT_NODE=1,DOCUMENT_FRAGMENT_NODE=11,TEXT_NODE=3,COMMENT_NODE=8,randomLocalsScopeName=`___$locals$___${Date.now()}`,IS_PROXY=Symbol("IS_PROXY"),PARENT_PATH=Symbol("PARENT_PATH");class ___IterableWeakSet extends Set{add(e){for(const t of super.values())if(t.deref()==e)return this;return super.add(new WeakRef(e)),this}forEach(e){super.forEach(((t,n)=>{const o=t.deref();o?e(o,t):super.delete(t)}))}*[Symbol.iterator](){for(const e of super.values()){const t=e.deref();t&&(yield t)}}}class IterableWeakSet{constructor(){this.__set=new Set}deleteByValue(e){for(const t of this.__set.values())t.deref()==e&&this.__set.delete(t)}deleteByRef(e){this.__set.delete(e)}add(e){for(const t of this.__set.values())if(t.deref()==e)return t;const t=new WeakRef(e);return this.__set.add(t),t}forEach(e){this.__set.forEach((t=>{const n=t.deref();n?e(n,t):this.__set.delete(t)}))}*[Symbol.iterator](){for(const e of this.__set.values()){const t=e.deref();t&&(yield t)}}}var LOOP_CONDITION_STATEMENT;!function(e){e[e.CONTINUE=0]="CONTINUE",e[e.BREAK=1]="BREAK",e[e.RETURN=2]="RETURN",e[e.NOTHING=3]="NOTHING"}(LOOP_CONDITION_STATEMENT||(LOOP_CONDITION_STATEMENT={}));const EXPRESSION_REGEX=/{([^{}]+?)}/g;var DOM_RENDER_ACTION_TYPE;!function(e){e[e.REPLACE=0]="REPLACE",e[e.REORDER=1]="REORDER",e[e.ATTRS=2]="ATTRS",e[e.TEXT=3]="TEXT"}(DOM_RENDER_ACTION_TYPE||(DOM_RENDER_ACTION_TYPE={}));class DirtyableValue{constructor(e,t){this._dirty=!1,this._pathKey="",this._value=e,this._pathKey=t}static isPrimitiveValue(e){return null===e||["undefined","boolean","number","string","symbol"].includes(typeof e)}get value(){return this._value}set value(e){this._dirty=!0,this._value=e}get isDirty(){return this._dirty}reset(){this._dirty=!1}toString(){return this._value}valueOf(){return this._value}}function isReflectable(e){return null!=e&&"function"!=typeof e&&!Array.isArray(e)&&"object"==typeof e}const toCamel=e=>e.replace(/([-_][a-z])/gi,(e=>e.toUpperCase().replace("-","").replace("_","")));function ___lambda(e,t={},n=null){return n&&(t=new Proxy(t,{has:()=>!0,get:(e,t,n)=>(console.log(t,t in e),Reflect.get(e,t,n))})),new Function(`with(this) {\n   try {\n    return ${e};\n   } catch(e) {\n   }\n  }`).call(t)}const lambda=function(){const e={};return function(t){let n=e[t];if(!n){try{n=new Function(`ctx, ${randomLocalsScopeName}`,`\n        if (!${randomLocalsScopeName} || !Object.keys(${randomLocalsScopeName}).length) {\n          ${randomLocalsScopeName} = {};\n        };\n        with(ctx) { \n          with(${randomLocalsScopeName}) { \n            return  ${t};\n          }\n        }`)}catch(e){throw new Error(`[Template Compile Error] SyntaxError:${e.message}`)}e[t]=n}return n}}(),stylesheet=new CSSStyleSheet,slice=Array.prototype.slice;function treeWalker(e,t){if(e.nodeType===ELEMENT_NODE||e.nodeType===DOCUMENT_FRAGMENT_NODE){let n=e.firstChild;for(;n;)t(n),treeWalker(n,t),n=n.nextSibling}}function walk(e,t){"length"in e||(e=[e]),e=slice.call(e);for(;e.length;){const n=e.shift();n.normalize();const o=t(n);if(o!==LOOP_CONDITION_STATEMENT.CONTINUE){if(o===LOOP_CONDITION_STATEMENT.BREAK)break;if(o===LOOP_CONDITION_STATEMENT.RETURN)return;n.childNodes&&n.childNodes.length&&(e=slice.call(n.childNodes).concat(e))}}}function compileWalker(e,t){"length"in e||(e=[e]),e=slice.call(e);for(;e.length;){const n=e.shift();n.normalize();const o=t(n);if(o!==LOOP_CONDITION_STATEMENT.CONTINUE){if(o===LOOP_CONDITION_STATEMENT.BREAK)break;if(o===LOOP_CONDITION_STATEMENT.RETURN)return;n.childNodes&&n.childNodes.length&&(e=slice.call(n.childNodes).concat(e))}}}function watchDom(e,t){const n=[],o=new MutationObserver((function(e,t){console.log(e,t)}));o.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,characterDataOldValue:!0,characterData:!0});try{walk(e.childNodes,t)}catch(e){}finally{o.takeRecords().forEach((e=>n.push(e))),o.disconnect()}}function subStrAtPos(e,t,n){const o=[];for(let s=0;s<t;s++){const t=e[n+s];t&&o.push(t)}return o.join("")}function extractVarsV2(e,t="{",n="}"){let o=0;const s=t.length,r=n.length,i=e.length,a=[],c=[],l=[];do{if(e.substring(o,o+s)==t)for(let d=o+1;d<=i-r;d++)if("'"===e[d]&&(1&c.length?c.pop():c.push(null)),'"'===e[d]&&(1&l.length?l.pop():l.push(null)),e.substring(d,d+s)!=t||c.length||l.length||(o=d),e.substring(d,d+r)==n&&!c.length&&!l.length){c.length=0,l.length=0;const t=o,n=d+r;a.push({start:t,end:n,expName:e.slice(t,n).trim(),varName:e.slice(t+s,d).trim()}),o=d+1;break}}while(++o<=e.length-t.length);return a}function extractVarsFromObject(e,t){const n=Object.keys(e).filter((t=>"function"!=typeof e[t]&&"object"!=typeof e[t])),o=new RegExp(`\\b(?:${n.join("|")})\\b`.replace(/\./,"\\."),"g");return t.match(o)||[]}function bindFunctionScope(ctx,fn){return function(){return eval(fn.toString())}.call(ctx)}const StateHandle={has:(e,t)=>t!==randomLocalsScopeName,get(e,t,n){if(t===IS_PROXY)return!0;if("startRecordExpressionVars"===t)return this.recordExpressionVars=new WeakSet,()=>{};if("stopRecordExpressionVars"===t)return()=>{const t=Object.keys(e);try{return t}finally{this.recordExpressionVars.clear(),delete this.recordExpressionVars}};if("symbol"!=typeof t&&Object.prototype.hasOwnProperty.call(e,t)&&this.recordExpressionVars){const o=n[PARENT_PATH];let s=t;o&&(s=`${o}.${String(t)}`),this.recordExpressionVars.add(s),console.log("__state get",t,t in e)}return Reflect.get(e,t,n)},set(e,t,n,o){Object.prototype.hasOwnProperty.call(e,t);let s=n;return isReflectable(n)&&(s=new StateProxy(n)),Reflect.set(e,t,s,o)},deleteProperty:(e,t)=>Reflect.deleteProperty(e,t),getOwnPropertyDescriptor(e,t){let n;if(n=Object.prototype.hasOwnProperty.call(e,t),n&&null!=n)return{value:n,enumerable:!0,configurable:!0,writable:!0}},ownKeys:e=>Reflect.ownKeys(e)};class StateProxy{constructor(e){return new Proxy(e,StateHandle)}}const loopNestedObj=e=>(Object.entries(e).forEach((([t,n])=>{isReflectable(n)?e[t]=loopNestedObj(n):console.log(t,n)})),new StateProxy(e));class EzWidget extends HTMLElement{constructor(){super(),this.__state=new StateProxy({}),this.varExpressionObj={},this.expressionNodeMap=new WeakMap,this.nodePositionMap=new WeakMap,this.compileContentNodeMap=new WeakMap,this.nodeActorsMap=new WeakMap,this.varBindNodeObj={},this.nodeBindVarObj=new WeakMap,this.compile=e=>{if("SCRIPT"==e.nodeName)return;if(e.nodeType===COMMENT_NODE||e.nodeType===DOCUMENT_FRAGMENT_NODE)return;if(e.nodeType===TEXT_NODE){const t=e;if(t.wholeText.trim()){const e=[],n=t.wholeText,o=extractVarsV2(n);if(o.length){let s=0;for(;o.length;){const{varName:t,expName:r,start:i,end:a}=o.shift();let c=n.substring(s,i);console.log(r,i,a);const l=extractVarsFromObject(this.__state,r);e.push(document.createTextNode(c)),c=r,"function"==typeof this.__state[t]&&(c=`{${t}()}`);let d=null,h=!1;if(r.startsWith("{!")){h=!0,d=document.createComment("");const t=document.createComment("");e.push(t),c=c.replace("{!","{")}else d=document.createTextNode(c);this.bindNodeExpression(d,{expression:"`$"+c+"`",vars:[t,...l]},(e=>{h?d.previousSibling.replaceWith(document.createRange().createContextualFragment(e)):d.textContent=e})),e.push(d),s=a}if(s<n.length){const t=n.substring(s);e.push(document.createTextNode(t))}t.replaceWith(...e)}}return LOOP_CONDITION_STATEMENT.CONTINUE}this.expandShorthandAttributes(e);const t=e.getAttributeNames(),n=t.find((e=>e.startsWith(":each-")));if(Boolean(n)&&n.startsWith(":each-")){const t=e.getAttribute(":each-key");if(!t)throw new Error("each expression need key");e.removeAttribute(":each-key");const o=e.getAttribute(n);let s=toCamel(n.replace(":each-","")),r=o;e.removeAttribute(n);const i=extractVarsV2(s);if(i[0]){const{varName:e}=i[0];s=e}const a=extractVarsV2(o);if(a[0]){const{varName:e}=a[0];r=e}let c=s;return"function"==typeof this.__state[s]&&(c=`${s}()`),this.bindNodeLoop(e,s,r,t),LOOP_CONDITION_STATEMENT.CONTINUE}for(let n=0;n<t.length;n++){const o=e.getAttributeNode(t[n]),s=o.name,r=o.value;if(s.startsWith(":if-")){const t=document.createComment(`if ${s}==${r}`);e.parentNode.insertBefore(t,e.nextSibling),e.removeAttribute(s);const n=extractVarsV2(r);if(n[0]){let{varName:t}=n[0],o=[];"function"==typeof this.__state[t]?t=`${t}()`:o=extractVarsFromObject(this.__state,t);const r=`${s.substring(4)} === ${t}`;this.bindNodeExpression(e,{expression:r,vars:o},(t=>{t?this.restoreRemoveNode(e):this.removeNode(e)}))}continue}if(s.startsWith(".")){console.log("[prop]",s,r);const t=extractVarsV2(r);t[0]&&this.bindNodeProp(e,s,t[0].varName);continue}const i=this.isTrigger(s)?[]:extractVarsV2(r);if(i.length){const t=[];let n=r;i.forEach((e=>{let o=e.expName;t.push(e.varName);const s=this.__state[e.varName];"function"!=typeof s&&void 0!==s||(o=`{'${e.varName}'}`);const r=new RegExp(e.expName,"g");n=n.replace(r,"$"+o)})),this.bindNodeExpression(e,{expression:"`"+n+"`",vars:t},(t=>{e.setAttribute(s,t)}))}if(s.startsWith("@")){e.removeAttribute(s);const t=s.substring(1);console.log("[event]",s,r);const n=extractVarsV2(r);let o=r;if(n&&n.length)for(let e=0;e<n.length;e++){const t=n[e];let s=t;t&&t.varName&&(s=t.varName),this.sourceRef[s]&&(o=s)}console.log("callback",o),e.addEventListener(t,(e=>{fastdom.mutate((()=>{this.sourceRef[o](e)}))}))}}},console.log("constructor");const e=this.attachShadow({mode:"open"});e.adoptedStyleSheets=[stylesheet],e.innerHTML="\n       <slot></slot>\n    ".replace(/[\s\n]*\n[\s\n]*/g,""),this.gcRegistry=new FinalizationRegistry((e=>{console.log("gcRegistry",e)}))}connectedCallback(){stylesheet.cssRules.length,this.cacheIfTagDomFragment=document.createDocumentFragment(),this.cacheLoopTagDomFragment=document.createDocumentFragment(),this.dispatchEvent(new CustomEvent("created",{bubbles:!0,detail:this})),console.log(22222),compileWalker(this.childNodes,this.compile),this.dispatchEvent(new CustomEvent("mounted",{detail:this}))}render(){}getInternalKey(e){return e}makeStateReflectable(e,t,n=""){const o=this,s=Object.keys(t);for(let r=0;r<s.length;r++){const i=s[r],a=t[i],c=`${n?`${n}.`:""}${i}`,l=this.getInternalKey(c);e[l]=a,"function"!=typeof a&&(isReflectable(a)?o.makeStateReflectable(e,a,c):Object.defineProperty(t,i,{get:()=>(console.log("[state] [GET]",l,e[l]),e[l]),set(n){if(console.log("[state] [SET]",l,n),isReflectable(n))return void o.makeStateReflectable(e,n,c);if("function"==typeof n&&(n=bindFunctionScope(t,n)),e[l]===n)return;e[l]=n;const s=o.varBindNodeObj[l];s&&s.forEach(((e,t)=>{console.log(999,e),o.nodeActorsMap.get(e).forEach((e=>{console.log(998,e),fastdom.mutate((()=>{e()}))}))}))}}))}}setState(e){this.sourceRef=e,this.makeStateReflectable(this.__state,e),this.render()}removeNode(e){const t=e.nextSibling,n=e.previousSibling;this.nodePositionMap.set(e,{parent:e.parentElement,next:t,prev:n}),this.cacheIfTagDomFragment.appendChild(e)}restoreRemoveNode(e){const t=this.nodePositionMap.get(e);if(!t)return;const{parent:n,next:o,prev:s}=t;o?n.insertBefore(e,o):n.appendChild(e)}getNodeCompileScope(e){const t=e.parentNode,n=this.compileContentNodeMap.get(t),o=this.compileContentNodeMap.get(e);return Object.assign(Object.assign({},n),o)}bindVarToNode(e,t){this.varBindNodeObj[e]||(this.varBindNodeObj[e]=new IterableWeakSet),this.varBindNodeObj[e].add(t),this.nodeBindVarObj.get(t)||this.nodeBindVarObj.set(t,new Set),this.nodeBindVarObj.get(t).add(e)}bindNodePropAction(e,t,n){if(!e.parentElement)return;e.removeAttribute(t);const o=lambda(n);this.__state.startRecordExpressionVars(),this.__state.stopRecordExpressionVars().forEach((t=>{this.varExpressionObj[t]||(this.varExpressionObj[t]=new Set),this.varExpressionObj[t].add(e)}));const s=((e,t,n)=>{const o=this.getNodeCompileScope(e),s=t(this.__state,o);e.setAttribute(n,s)}).bind(null,e,o,t.substring(1));this.expressionNodeMap.get(e)||this.expressionNodeMap.set(e,new Set),this.expressionNodeMap.get(e).add(s),s()}bindNodeExpression(e,t,n){let o=()=>{};o=t.runtimeFn?t.runtimeFn:lambda(t.expression),t.vars.forEach((t=>{Object.prototype.hasOwnProperty.call(this.__state,t)&&"function"!=typeof this.__state[t]&&this.bindVarToNode(t,e)})),this.bindNodeActor(e,(t=>{if(!t){const n=this.getNodeCompileScope(e);t=o(this.__state,n)}n(t)}),(()=>{if(!e.parentNode)return;const n=this.getNodeCompileScope(e);let s=null;return t.monitState?(this.__state.startRecordExpressionVars(),s=o(this.__state,n),this.__state.stopRecordExpressionVars().forEach((t=>{this.bindVarToNode(t,e)}))):s=o(this.__state,n),s}))}bindNodeLoop(e,t,n,o=""){const s=document.createComment(`each ${n} of ${t}`),r=document.createComment("end each");e.parentNode.insertBefore(s,e),e.parentNode.insertBefore(r,e.nextSibling),this.cacheLoopTagDomFragment.appendChild(e),"function"!=typeof this.__state[t]&&this.bindVarToNode(t,e);const i={expression:`${t}`,vars:[t]},a=(t,n,o,s)=>{let i=t.length,a=n.length;const c={};let l=i;const d=new Map;for(;l--;){const e=this.compileContentNodeMap.get(t[l])[s].item[o];c[e]=l,d.set(e,t[l])}console.log("old_indexes",c);const h=[],u=new Map,p=new Map;for(l=a;l--;){const t=n[l][o];let s=d.get(t);s?console.log("update",t):(s=e.cloneNode(!0),s.___uniqueItemKey=t,s.detach=()=>{this.nodeBindVarObj.get(s).forEach((e=>{const t=this.varBindNodeObj[e];t.forEach(((e,n)=>{e===s&&t.deleteByRef(n)}))})),this.nodeActorsMap.delete(s)}),u.set(t,h[l]=s),t in c&&p.set(t,Math.abs(l-c[t]))}let f=r;const _=new Set,m=new Set,b=(e,t)=>{console.log(this.varBindNodeObj),t.delete(e.___uniqueItemKey),e.remove(),e.detach(),console.log("destory",e,t)},N=e=>{d.set(e.___uniqueItemKey,e),f?r.parentNode.insertBefore(e,f):r.parentNode.appendChild(e);const t=n[a-1],o=a,i=this.compileContentNodeMap.get(e);this.compileContentNodeMap.set(e,Object.assign(Object.assign({},i),{[s]:{item:t,index:o,key:e.___uniqueItemKey}})),compileWalker(e,this.compile),f=e,a--};for(;i&&a;){const e=h[a-1],n=t[i-1],o=e.id,s=n.key;e===n?(f=e.first,i--,a--):u.has(s)?!d.has(o)||_.has(o)?N(e):m.has(s)?i--:p.get(o)>p.get(s)?(m.add(o),N(e)):(_.add(s),i--):(b(n,d),i--)}for(;i--;){const e=t[i];u.has(e[o])||b(e,d)}for(;a;)N(h[a-1]);return h};this.bindNodeExpression(e,i,(t=>{let c=e.___bind_meta;console.log(i),c&&Array.isArray(c)||(c=[]);const l=[];let d=s.nextSibling;for(;d&&d!=r;){const e=d.nextSibling;l.push(d),d=e}a(l,t,o,n),e.___bind_meta=t}))}bindNodeProp(e,t,n){const o=t.substring(1);e.removeAttribute(t),e.addEventListener("input",(t=>{const s=n.split(".");let r=this.sourceRef;const i=s.pop();for(;s.length;)r=r[s.shift()];const a=e.type,c=a.charAt(0).toUpperCase()+a.slice(1);let l=`${o}As${c}`;void 0===e[l]&&(l=o),r[i]=e[l]})),this.bindNodeExpression(e,{expression:n,vars:[n]},(t=>{e[o]=t}))}bindStateFunction(fn){return function(){return eval(fn.toString())}.call(this.__state)}bindNodeActor(e,t,n){this.nodeActorsMap.get(e)||this.nodeActorsMap.set(e,new Set),this.gcRegistry.register(t,"gc actor fn"),this.nodeActorsMap.get(e).add(t),fastdom.measure((()=>{const e=n();fastdom.mutate((()=>{t(e)}))}))}expandShorthandAttributes(e){const t=e.getAttributeNames();for(let n=0;n<t.length;n++){const o=e.getAttributeNode(t[n]);let s=o.name,r=o.value;const i=EXPRESSION_REGEX.exec(s);if(EXPRESSION_REGEX.lastIndex=0,i)if(e.removeAttribute(s),s=i[1],s.trim().startsWith("...")){const t=s.trim().replace("...",""),n=this.sourceRef[t];if(this.sourceRef[t]){const o=Object.keys(n);for(let n=0;n<o.length;n++){const s=o[n];r=`{${t}.${s}}`,e.setAttribute(s,r)}}}else r=`{${s}}`,e.setAttribute(s,r)}}isTrigger(e){return e.startsWith("@")}disconnectedCallback(){}static get observedAttributes(){return[]}attributeChangedCallback(e,t,n){}adoptedCallback(){}}__webpack_unused_export__=EzWidget,customElements.define("ez-widget",EzWidget)})();
//# sourceMappingURL=ez-widget.js.map